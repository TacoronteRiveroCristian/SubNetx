#!/bin/bash
# Descripcion: Script principal para gestionar OpenVPN.

source /app/config/openvpn/config.sh

function usage() {
    echo "Uso: $0 {setup|start|stop|client {new|delete} [--name <nombre>] [--ip <ip>]}"
    exit 1
}

COMMAND=$1
SUBCOMMAND=$2

# Variables para client new
CLIENT_NAME=""
CLIENT_IP=""

if [[ $EUID -ne 0 ]]; then
    echo "Este script debe ejecutarse como root." >&2
    exit 1
fi

# Parsear argumentos para client new
if [[ "$COMMAND" == "client" && "$SUBCOMMAND" == "new" ]]; then
    shift 2  # Eliminar "client" y "new" de los argumentos
    while [[ "$#" -gt 0 ]]; do
        case "$1" in
            --name) CLIENT_NAME="$2"; shift 2 ;;
            --ip) CLIENT_IP="$2"; shift 2 ;;
            *) echo "❌ Error: Opción desconocida $1"; usage ;;
        esac
    done
fi

case $COMMAND in
    setup)
        "/app/scripts/openvpn-setup.sh"
        ;;
    start)
        "/app/scripts/openvpn-start.sh"
        ;;
    stop)
        "/app/scripts/openvpn-stop.sh"
        ;;
    client)
        case $SUBCOMMAND in
            new)
                if [[ -z "$CLIENT_NAME" || -z "$CLIENT_IP" ]]; then
                    echo "❌ Debes especificar --name y --ip."
                    usage
                fi
                "/app/scripts/openvpn-client-new.sh" --name "$CLIENT_NAME" --ip "$CLIENT_IP"
                ;;
            delete)
                # Lógica para delete
                ;;
            *)
                usage
                ;;
        esac
        ;;
    *)
        usage
        ;;
esac
