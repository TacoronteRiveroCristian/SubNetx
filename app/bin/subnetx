#!/bin/bash
# Descripcion: Script principal para gestionar OpenVPN.

export BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
source "$BASE_DIR/app/config/openvpn/config.sh"

# Dar permisos iniciales para evitar problemas de acceso durante la configuracion
sudo chown -R subnetx:subnetx "$OPENVPN_DIR"
sudo chmod -R 755 "$OPENVPN_DIR"

function usage() {
    echo "Uso: $0 {setup|run|stop|client {create|delete} <nombre_cliente>}"
    exit 1
}

COMMAND=$1
SUBCOMMAND=$2
CLIENT_NAME=$3

case $COMMAND in
    setup)
        "$BASE_DIR/app/scripts/openvpn-setup.sh"
        ;;
    run)
        "$BASE_DIR/app/scripts/openvpn-run.sh"
        ;;
    stop)
        "$BASE_DIR/app/scripts/openvpn-stop.sh"
        ;;
    client)
        case $SUBCOMMAND in
            create)
                if [ -z "$CLIENT_NAME" ]; then
                    echo "‚ùå Debes especificar un nombre de cliente."
                    usage
                fi
                "$BASE_DIR/app/scripts/openvpn-client-create.sh" "$CLIENT_NAME"
                ;;
            delete)
                if [ -z "$CLIENT_NAME" ]; then
                    echo "‚ùå Debes especificar un nombre de cliente."
                    usage
                fi
                echo "üóëÔ∏è Eliminando cliente: $CLIENT_NAME"
                ;;
            *)
                usage
                ;;
        esac
        ;;
    *)
        usage
        ;;
esac

# Asegurar permisos adecuados
sudo chmod -R 600 "$OPENVPN_DIR"
sudo chmod -R 700 "$EASYRSA_DIR"
sudo chmod 600 "$SERVER_CONF"
